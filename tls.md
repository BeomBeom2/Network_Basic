## π“ TLS(Transport Layer Security) ν”„λ΅ν† μ½

### 1. TLS κµ¬μ΅°

![](https://media.vlpt.us/images/saseungmin/post/1ecb3aaa-16ad-4a59-a6bb-5f4384353122/500px-TLS_protocol_stack.PNG)

-   TLSλ” λ‹¨μΌ ν”„λ΅ν† μ½μ΄ μ•„λ‹κ³   **2κ³„μΈµμ— κ±ΈμΉ ν”„λ΅ν† μ½μ΄λ‹¤.**
-   **Record ν”„λ΅ν† μ½**μ€ μ΄λ°μμ΄λ©°, μ‘μ© κ³„μΈµμΌλ΅λ¶€ν„° μ¤λ” λ°μ΄ν„°λΏλ§ μ•„λ‹λΌ TLSμ μƒμ„ ν”„λ΅ν† μ½λ΅λ¶€ν„° μ¤λ” λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•λ‹¤. Record ν”„λ΅ν† μ½μ—μ„ μ¤λ” λ©”μ‹μ§€λ” λ³΄ν†µ TCPμΈ μ „μ†΅ κ³„μΈµμ νμ΄λ΅λ“μ΄λ‹¤.
-   **Handshake ν”„λ΅ν† μ½**μ€ Record ν”„λ΅ν† μ½μ— λ€ν• λ³΄μ• λ§¤κ°λ³€μλ¥Ό μ κ³µν•λ‹¤.
 -   μ•”νΈ μ§‘ν•©μ„ μ„¤μ •ν•κ³  ν‚¤μ™€ λ³΄μ• λ§¤κ°λ³€μλ¥Ό μ κ³µν•λ‹¤
-   λν•, ν•„μ”ν•λ‹¤λ©΄ ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ— λ€ν•΄ κ·Έλ¦¬κ³  μ„λ²„κ°€ ν΄λΌμ΄μ–ΈνΈμ— λ€ν•΄ μΈμ¦λλ‹¤.
-   **ChangeCipherSpec ν”„λ΅ν† μ½**μ€ μ•”νΈν•™μ  λΉ„λ°€μ„ μ‹ μ†ν•κ² λ³΄λ‚΄λ” λ° μ‚¬μ©λλ‹¤.
-   **Alert ν”„λ΅ν† μ½**μ€ λΉ„μ •μƒ μ΅°κ±΄μ„ μ•λ¦¬λ”λ° μ‚¬μ©λλ‹¤.
-   **Heartbeat ν”„λ΅ν† μ½**μ€ ν”„λ΅ν† μ½ κ°μ²΄μ κ°€μ©μ„±μ„ λ¨λ‹ν„°λ§ ν•  λ• μ‚¬μ©λλ‹¤.


![](https://media.vlpt.us/images/saseungmin/post/1e475cb7-9f58-4c09-884f-accb3abe9c14/TLS-handshake-protocol.png)


### 1.Hello Request

- μ„λ²„κ°€ μ•„λ¬΄ λ•λ‚ λ³΄λ‚Ό μ μλ” λ©”μ‹μ§€, ν΄λΌμ΄μ–ΈνΈμ—κ² Client Hello λ©”μ‹μ§€λ¥Ό λ³΄λ‚΄μ–΄ ν‘μƒμ„ μ”κµ¬ν•λ” λ©”μ‹μ§€μ΄λ‹¤. ν„μ¬ ν‘μƒμ΄ μ§„ν–‰ μ¤‘μ΄λ©΄ ν΄λ¦¬μ΄μ–ΈνΈλ” μ΄ λ©”μ‹μ§€λ¥Ό λ¬΄μ‹ν•λ‹¤.
- μ„λ²„λ” HelloRequestλ¥Ό λ³΄λ‚΄κ³  μ΄μ— λ€ν• Hanshakeκ°€ λλ‚μ§€ μ•μ€ μƒνƒμ—μ„ λ λ‹¤μ‹ HelloRequestλ¥Ό λ³΄λ‚΄λ©΄ μ•λλ‹¤.

### 2. ClientHello

 - ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ— μ²μμΌλ΅ μ—°κ²°μ„ μ‹μ‘ν•κ±°λ‚ HelloRequst λ©”μ‹μ§€μ— λ€ν• μ‘λ‹µμΌλ΅ ClientHello λ©”μ‹μ§€λ¥Ό λ³΄λ‚Έλ‹¤.
 - ClientHello λ©”μ‹μ§€λ” μ„Έμ… μ‹λ³„μ, CipherSuite λ¦¬μ¤νΈ, ν΄λΌμ΄μ–ΈνΈκ°€ μ§€μ›ν•λ” μ••μ¶• μ•κ³ λ¦¬μ¦ λ¦¬μ¤νΈ, SSL λ²„μ „, λ‚μλ¥Ό μ„λ²„μ— μ „λ‹¬ν•λ‹¤.
	 - cipher_suites : CipherSuite λ¦¬μ¤νΈλ” ν‚¤ κµν™ μ•κ³ λ¦¬μ¦, μ•”νΈ μ•κ³ λ¦¬μ¦, MAC μ•κ³ λ¦¬μ¦μ„ ν¬ν•¨ν•λ‹¤.
	 - ν•μ‹μ€ SSL/TLS-(A)-WITH-(B) : Aλ” ν‚¤ κµν™ λ° μΈμ¦ μ•κ³ λ¦¬μ¦, Bλ” cipher spec(μ•”νΈ λ…μ„Έ)λ” λ€μΉ­ μ•”νΈ μ•κ³ λ¦¬μ¦, μ•”νΈν‚¤ κΈΈμ΄, λΈ”λ­ μ•”νΈ λ¨λ“, HMACμ© ν•΄μ‹ μ•κ³ λ¦¬μ¦ λ“±μΌλ΅ κµ¬μ„±λλ‹¤.
	 - ex) (B) = TLS-RSA-WITH-AES-256-CBC-SHA256 : AECλ¥Ό μ‚¬μ©ν•λ©° μ•”νΈν‚¤ κΈΈμ΄λ” 256λΉ„νΈ, λΈ”λ΅ μ•”νΈ λ¨λ“λ” CBCμ΄κ³ , HMACμ© ν•΄μ‹ μ•κ³ λ¦¬μ¦μ€ SHA-256μ„ μ‚¬μ©ν•λ” cipher suite

### 3.ServerHello

 - μ„λ²„λ” ClientHello λ©”μ‹μ§€μ— λ€ν• μ‘λ‹µμΌλ΅ ServerHello λ©”μ‹μ§€λ¥Ό λ³΄λ‚Έλ‹¤. μ‹¤ν¨ ν•  κ²½μ°μ—λ” HandsShake Failure Alert λ©”μ‹μ§€λ¥Ό λ„μ΄λ‹¤.
 - ServerHello λ©”μ‹μ§€λ” μ„Έμ… μ‹λ³„μ, μ„ νƒν• CipherSUite, μ„ νƒν• μ••μ¶•λ°©λ²•, μ„λ²„ SSL λ²„μ „, μ„λ²„κ°€ μƒμ„±ν• λ‚μλ¥Ό ν΄λΌμ΄μ–ΈνΈμ— μ „λ‹¬ν•λ‹¤.


## π”¶ 1 λ‹¨κ³„ : λ³΄μ• κΈ°λ¥ ν™•λ¦½ ν›„
 
  - SSL λ²„μ „
  - ν‚¤ κµν™, λ©”μ‹μ§€ μΈμ¦κ³Ό μ•”νΈν™”λ¥Ό μ„ν• μ•κ³ λ¦¬μ¦
  - μ••μ¶• λ°©λ²•
  - ν‚¤ μƒμ„±μ„ μ„ν• 2κ°μ λ‚μ

### 4. Server Certificate 

 - μ„λ²„μ μΈμ¦μ΄ ν•„μ”ν• κ²½μ°μ— μ„λ²„λ” ServerHello λ’¤μ— μ„λ²„μ μΈμ¦μ„κ°€ ν¬ν•¨λ Certificateμ„ λ³΄λ‚΄μ•Ό ν•λ‹¤.
 - μ΄ λ• μ„λ²„μ μΈμ¦μ„λ” μ„ νƒλ cipher suiteμ ν‚¤ κµν™ μ•κ³ λ¦¬μ¦μ— λ§λ” νƒ€μ…μ΄μ–΄μ•Ό ν•λ‹¤.

### 5. Server Key Exchange

 - μ„λ²„μ μΈμ¦μ„λ¥Ό λ³΄λ‚΄μ§€ μ•μ•κ±°λ‚ λ³΄λ‚Έ μΈμ¦μ„μ— ν‚¤ κµν™μ— ν•„μ”ν• μ •λ³΄κ°€ λ¶€μ΅±ν•λ©΄ μ „μ†΅λλ” λ©”μ‹μ§€.

### 6. Ceritificate Request 
 - μ„λ²„λ” μμ‹ μ„ ν΄λΌμ΄μ–ΈνΈμ—κ² μΈμ¦ν•¨κ³Ό λ™μ‹μ— ν΄λΌμ΄μ–ΈνΈμ—κ² ν΄λΌμ΄μ–ΈνΈμ μΈμ¦μ„λ¥Ό ν†µν• μΈμ¦μ„ μ”κµ¬ν•  μ μλ‹¤.
 - μ΄ λ©”μ‹μ§€λ” μ„ νƒμ μΌλ΅ μ‚¬μ©λκ³  μ‚¬μ©ν•  μ‹μ—” μ„λ²„μ™€ ν΄λΌμ΄μ–ΈνΈμ μƒνΈ μΈμ¦μ΄ μ΄λ£¨μ–΄μ§„λ‹¤.

### 7. ServerHelloDone
 - μ„λ²„κ°€ λ³΄λ‚Ό λ©”μ‹μ§€λ¥Ό λ‹¤ λ³΄λƒμμ„ μ•λ ¤μ£Όλ” λ©”μ‹μ§€.

## π”¶ 2 λ‹¨κ³„ : μ„λ²„ μΈμ¦κ³Ό ν‚¤ κµν™ ν›„μ— μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈμ— λ€ν•΄ μΈμ¦λκ³  ν΄λΌμ΄μ–ΈνΈλ” ν•„μ”ν•λ‹¤λ©΄ μ„λ²„μ κ³µκ°ν‚¤λ¥Ό μ• μ μλ‹¤.

### 8. Client Certificate 
 - (6)μ— λ€ν• μ‘λ‹µ : μ„λ²„κ°€ ν΄λΌμ΄μ–ΈνΈμ μΈμ¦μ„ μ”κµ¬ν•  κ²½μ° ν΄λΌλ¦¬μ–ΈνΈκ°€ λ³΄λ‚΄λ” λ©”μ‹μ§€ 
 
### 9. Client Key Exchange
 - ν΄λΌμ΄μ–ΈνΈλ” μ„Έμ…ν‚¤λ¥Ό μƒμ„±ν•κΈ° μ„ν•΄ μ„μμ λΉ„λ°€ μ •λ³΄μΈ 48λ°”μ΄νΈ pre-master-secretμ„ μƒμ„±ν•λ‹¤.
 - κ·Έ ν›„ μ„ νƒλ μ•κ³ λ¦¬μ¦(RSA, Fortezza, Diffi-Helllman μ¤‘ ν•λ‚)μ„ μ΄μ©ν•μ—¬ pre-master-secretμ„ μ„λ²„μ™€ κ³µμ 

### 10. Ceritificate Verify
 - ν΄λΌμ΄μ–ΈνΈ μΈμ¦μ„μ λ…λ°±ν• ν™•μΈμ„ μ„ν•΄ ν΄λΌμ΄μ–ΈνΈλ” ν•Έλ“ μ‰μ΄ν¬ λ©”μ‹μ§€λ¥Ό μ „μ μ„λ…ν•μ—¬ μ „μ†΅ν•λ‹¤.

## π”¶ 3 λ‹¨κ³„ : ν΄λΌμ΄μ–ΈνΈ μΈμ¦κ³Ό ν‚¤ κµν™ ν›„μ— ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ— λ€ν•΄ μΈμ¦λκ³  ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„ μ–‘μΈ΅μ€ μ‚¬μ „ λ§μ¤ν„° λΉ„λ°€μ„ μ•κ² λλ‹¤.

### 11. ChangeCipherSpec, Finished 
 
 - ChangeCiphterSpec λ©”μ‹μ§€λ” ν•Έλ“ μ‰μ΄ν¬ ν”„λ΅ν† μ½μ— ν¬ν•¨λλ” κ²ƒμ€ μ•„λ‹κ³ , μ΄ λ©”μ‹μ§€ μ΄ν›„μ— μ „μ†΅λλ” λ©”μ‹μ§€λ” μƒλ΅­κ² ν‘μƒ λ μ•κ³ λ¦¬μ¦κ³Ό ν‚¤λ¥Ό μ΄μ©ν•  κ²ƒμ„μ„ λ‚νƒ€λ‚Έλ‹¤.
 - Finished λ©”μ‹μ§€λ” ChangeCipherSpec λ©”μ‹μ§€ μ΄ν›„μ— μ „μ†΅λλ©°, ν‘μƒ λ μ•κ³ λ¦¬μ¦κ³Ό ν‚¤κ°€ μ²μμΌλ΅ μ μ©λκ³  μƒλ€νΈμ—μ„ μ΄ λ©”μ‹μ§€λ¥Ό ν†µν•΄μ„ ν‘μƒν• κ²°κ³Όλ¥Ό ν™•μΈν•κ² λλ‹¤.
 - μ΄ν›„ μ• ν”λ¦¬μΌ€μ΄μ… λ°μ΄ν„°κ°€ μ „μ†΅λλ‹¤.

## π”¶ 4 λ‹¨κ³„ : μΆ…λ£ λ‹¨κ³„ μ΄ν›„ ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„λ” λ°μ΄ν„°λ¥Ό κµν™ν•  μ¤€λΉ„κ°€ λλ‹¤.


### reference [SSL/TLS](https://velog.io/@saseungmin/SSLTLS-%EB%B3%B4%EC%95%88)
